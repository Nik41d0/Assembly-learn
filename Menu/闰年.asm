DATAS SEGMENT
    MENU DB 10,13,"|         WELCOME TO THE DATE SYSTEM        |"
    	 DB 10,13,"|*******************************************|"
    	 DB 10,13,"|******** Press 1:start the system *********|"
    	 DB 10,13,"|******** Press ESC:exit the system ********|"
    	 DB 10,13,"|*******************************************|"
	LEN1=$-MENU
	STR1 DB 10,13,"PLEASE INPUT A KEY:"
	LEN0=$-STR1
	STR2 DB "PLEASE INPUT A YEAR:"
	LEN2=$-STR2
	STRE DB 10,13,"PRESS ESC IS EXIT"
	LENE=$-STRE
	ERROR DB 10,13,"INPUT ERROR",10,13,"$"
	
	JUDGEN DB " is not a leap year",10,13,"$"
	JUDGEY DB " is a leap year",10,13,"$"
	CAL1 DB "Please input the month:"
	LEN3=$-CAL1
	CAL2 DB "Please input the day:"
	LEN4=$-CAL2
	CAL3 DB " is the $"
	CAL4 DB " day of the year",10,13,"$"
	CAL5 DB "PRESS ENTER TO CONTINUE",10,13
	LENC=$-CAL5
	
	YEAR DW ?
	X DW ?
	Y DW ?
	Z DW ?
	FLAG DW ?
	CAL_M DW ?
	CAL_D DW ?
	NUM DW 0,31,29,31,30,31,30,31,31,30,31,30,31
	GAP DW ?
	N DW ?
	TEN DW 10
	
	BUF1 DB "01.02.03.04.05.06.07.08.09.10.11.12."
	BUF2 DB "31,29,31,30,31,30,31,31,30,31,30,31"
	BUF3 DB "31,28,31,30,31,30,31,31,30,31,30,31"
	BUF21 DB "31 60 91 121152182213244274305335366"
	BUF31 DB "31 59 90 120151181212243273304334365"
	
	BUFEN DB 10,13,"$"
	FILE_NAM DB "C:\\test1.txt",0
	FILE_IF  DB "Press y to save it to TEST1.TXT: "
	LEN5=$-FILE_IF
	FILE_OK  DB 10,13,"SAVE SUCCESS!"
	LENF=$-FILE_OK
	FILE_ERR DB "ERROR!",10,13,"$"
	F1 DW ?
	
PRINTS MACRO A
	MOV AH,9
	LEA DX,A
	INT 21H
ENDM

PRINTNUM MACRO A
	LOCAL LP01,LP02
	MOV CX,0
	MOV AX,A
	CWD   
LP01:
	DIV TEN
	PUSH DX
	INC CX
	CMP AX,0
	CWD      
	JNZ LP01
LP02:
	POP DX
	ADD DL,30H
	MOV AH,2
	INT 21H
	LOOP LP02	
ENDM

ERROR01 MACRO A
	PRINTS ERROR
	JMP A
ENDM

CLEAR MACRO
	MOV AH,6
	MOV AL,0
	MOV BH,07H
	MOV CX,0	;0行0列
	
	MOV DH,80	;行
	MOV DL,80	;列
	INT 10H
ENDM

OUTFILE MACRO A,B
	MOV CX,A
	LEA DX,B
	MOV AH,40H
	INT 21H 
	JC ERR
ENDM

READ MACRO
	MOV AH,3
	MOV BH,0
	INT 10H
ENDM

PRINTC MACRO A,B
	READ
	MOV AX,1301H
   	MOV BL,0EH	
   	LEA BP,A
    MOV BH,0	;0页
    MOV CX,B
    INT 10H
ENDM

DATAS ENDS

STACKS SEGMENT
    ;此处输入堆栈段代码
STACKS ENDS

CODES SEGMENT
    ASSUME CS:CODES,DS:DATAS,SS:STACKS
START:
    MOV AX,DATAS
    MOV DS,AX
    MOV ES,AX
    
    CALL MENUS
    MOV AH,4CH
    INT 21H
        
JUDGE PROC
L0:
	CLEAR
	AND DH,0	;行
	AND DL,0	;列
	MOV BH,0	;页
	MOV AH,2
	INT 10H
LP01:
	READ
	MOV AX,1301H
   	MOV BL,0EH	
   	LEA BP,STR2
    MOV BH,0	;0页
    MOV CX,LEN2
    INT 10H
    
	XOR DX,DX
	XOR BX,BX
	AND FLAG,0
	CALL GETNUM
	MOV YEAR,BX 
	.IF YEAR==0
		ERROR01 LP01
	.ENDIF
LP03:
	MOV DX,0
	MOV AX,YEAR	;/400
	MOV BX,400 	
	DIV BX
	MOV X,DX
		
	MOV DX,0	;/100
	MOV AX,YEAR
	MOV BX,100
	DIV BX
	MOV Y,DX
		
	MOV DX,0	;/4
	MOV AX,YEAR
	MOV BX,4
	DIV BX 
	MOV Z,DX
	
	PRINTNUM YEAR
	.IF X==0 ||(Y!=0&&Z==0)	;能被400整除 或者 不能被100整除却能被4整除
		PRINTS JUDGEY
	.ELSE
		INC FLAG
		PRINTS JUDGEN
	.ENDIF
	PRINTC CAL5,LENC
	
	MOV AH,1
	INT 21H
	CMP AL,27
	JZ L0	
	RET
JUDGE ENDP

CALCULATE PROC
L0:
	AND GAP,0
	PRINTC CAL1,LEN3
	CALL GETNUM
	MOV CAL_M,BX
	
	.IF CAL_M<1 || CAL_M>12
		ERROR01 L0
	.ELSEIF CAL_M>2 &&FLAG==1
		DEC GAP
	.ENDIF
L1:
	PRINTC CAL2,LEN4
	CALL GETNUM
	MOV CAL_D,BX
		
	.IF CAL_D<1 || CAL_D>31
		ERROR01 L1
	.ELSEIF CAL_M==2 && CAL_D>29	;二月不能大于29天
		ERROR01 L1
	.ELSEIF CAL_M==2 && FLAG==1 && CAL_D>28	;平年的二月只有28天
		ERROR01 L1
	.ENDIF
	
	PRINTNUM CAL_M
	MOV AH,2
	MOV DL,"."
	INT 21H
	PRINTNUM CAL_D

	MOV CX,CAL_M
	AND BX,0
	AND AX,0
LP01:
	ADD AX,[NUM+BX]
	INC BX
	INC BX
	LOOP LP01
	ADD AX,CAL_D
	ADD GAP,AX
	
	PRINTS CAL3
	PRINTNUM GAP
	PRINTS CAL4
	   
	PRINTC CAL5,LENC
	MOV AH,1
	INT 21H
	CMP AL,27
	JZ L0	
	RET
CALCULATE ENDP

CAL_ALL PROC
	CLEAR
	MOV DH,0
	MOV DL,0
	MOV BH,0
	MOV AH,2
	INT 10H
	PRINTNUM YEAR
	MOV AH,2
	MOV DL,10
	INT 21H
	
	AND N,0
	AND BX,0
	AND GAP,0
	INC N
	INC BX
	INC BX
LP0:
	PRINTNUM N
	MOV AH,2
	MOV DL,"."
	INT 21H
	
	MOV AX,GAP
	.IF FLAG==1 && BX==4
		DEC [NUM+BX]
	.ENDIF
	ADD AX,[NUM+BX]
	MOV GAP,AX

	PRINTNUM [NUM+BX]
	INC BX
	INC BX
	PRINTS CAL3
	PRINTNUM GAP
	PRINTS CAL4
	
	INC N
	CMP N,13
	JNZ LP0
	
	.IF FLAG==1
		INC [NUM+4]
	.ENDIF
	RET
CAL_ALL ENDP

GETNUM PROC
LP01:
	XOR DX,DX
	XOR BX,BX
LP02:
    MOV AH,1
    INT 21H
    CMP AL,13		
    JZ LP03
    SUB AL,30H
    
    JL    ERROR1         
    CMP   AL, 9
    JG    ERROR1         
    
    CBW
    XCHG AX,BX
    IMUL TEN
    ADD BX,AX
    JMP LP02 
ERROR1:
	PRINTS ERROR
	JMP LP01
LP03:
	RET
GETNUM ENDP

WFILE PROC
	AND SI,0
	MOV N,12
	AND CX,0	;普通文件属性
	MOV AH,3CH	;创建文件
	LEA DX,FILE_NAM
	INT 21H
	JC ERR
	MOV F1,AX
	MOV BX,F1

LP01:
    OUTFILE 3,BUF1[SI]		;月

	.IF FLAG==1
		OUTFILE 2,BUF3[SI]
		OUTFILE 8,CAL3
		OUTFILE 3,BUF31[SI]
	.ELSE
		OUTFILE 2,BUF2[SI]		
		OUTFILE 8,CAL3
		OUTFILE 3,BUF21[SI]
	.ENDIF
	OUTFILE 16,CAL4
	OUTFILE 1,BUFEN
	ADD SI,3
	DEC N
	JNZ LP01
	
	PRINTC FILE_OK,LENF	
	RET
ERR:
	PRINTS FILE_ERR 

WFILE ENDP

MENUS PROC
L0:
	CLEAR
   	MOV AX,1301H 
   	MOV BL,4FH	;红底白字，红:0100 白:1111
   	MOV BP,OFFSET MENU
    MOV BH,0	;0页
    MOV DH,0	;行 
    MOV DL,0	;列
    MOV CX,LEN1
    INT 10H
	
	PRINTC STR1,LEN0
	MOV AH,1
	INT 21H
	
	.IF AL=="1"
		
		CALL JUDGE
		CALL CALCULATE
		CALL CAL_ALL
		PRINTC FILE_IF,LEN5
		
		MOV AH,1
		INT 21H
		.IF AL=="y" 
			CALL WFILE
		.ENDIF
	.ELSEIF AL==27
		JMP EXIT
	.ELSE
		PRINTS ERROR
	.ENDIF

	PRINTC STRE,LENE
	MOV AH,1
	INT 21H
	CMP AL,27
	JNZ L0	
	
EXIT:
	MOV AH,4CH
	INT 21H
MENUS ENDP
CODES ENDS
    END START
